<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($location, $rootScope) {
  /* widget controller */
  var c = this;
	
	function format(value) {
		if (!value) {
			return "";
		}
	}
	
	c.submit = function() {
		c.server.update().then(function(response) {
			if (c.data.invalidwidgetID || c.data.invalidPageID)
				return;
			
			$rootScope.$broadcast('$sp.widget-close-modal');
			var s = $location.search();
			s.sys_id = c.data.sys_id;
			c.redirecting = true;
			$location.search(s).replace();
		});
	}
	
	c.fixID = function(id) {
		if (!id) return;
		c.data.id = format(id.toString());
	}
	
	c.fixPageID = function(id) {
		if (!id) return;
		c.data.test_page_id = format(id.toString());
	}
}]]></client_script>
        <controller_as>c</controller_as>
        <css/>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>sendmail</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>sendMail</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
	//发送邮件方法
	function sendMail(input){
		data.invalidwidgetID = false;
		data.invalidPageID = false;
	
		//实例化表flow_mgnt_info
		var overtimeFlow = new GlideRecord('x_528469_flow_sear_flow_mgnt_info');
		//实例化表notificationRecord
		var notificationRecord = new GlideRecord('x_528469_flow_sear_info_records');
		//查询所有记录
		overtimeFlow.query();
		notificationRecord.query();
		//遍历每条记录
		while(overtimeFlow.next()){
			//将已经超时并且需要通知的记录晒出
			if(overtimeFlow.schedule_hnum < overtimeFlow.real_hnum && overtimeFlow.timeout_reminder_flag == 0){
				//初始化记录
				notificationRecord.initialize();
				
				notificationRecord.setValue("flow_no",overtimeFlow.flow_no);
				notificationRecord.setValue("regist_user_id",overtimeFlow.regist_user_id);
				notificationRecord.setValue("regist_mail",overtimeFlow.regist_mail);
				
				//插入记录后后台会根据插入的记录发信通知
				notificationRecord.insert();
			}
		}
	}
	
	if(input){
		sendMail(input);
	}
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2020-12-16 03:15:25</sys_created_on>
        <sys_id>1bfae6e207496010b340f03c7c1ed041</sys_id>
        <sys_mod_count>21</sys_mod_count>
        <sys_name>sendMail</sys_name>
        <sys_package display_value="Flow Search" source="x_528469_flow_sear">08c3af6407c92010b340f03c7c1ed0ae</sys_package>
        <sys_policy/>
        <sys_scope display_value="Flow Search">08c3af6407c92010b340f03c7c1ed0ae</sys_scope>
        <sys_update_name>sp_widget_1bfae6e207496010b340f03c7c1ed041</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2020-12-23 08:33:45</sys_updated_on>
        <template><![CDATA[<form name="timelist" ng-submit="c.submit()">
  タイムアウトしたflow作成者に送信します。
  <br />
  <button type="submit">送信</button>
</form>]]></template>
    </sp_widget>
</record_update>
